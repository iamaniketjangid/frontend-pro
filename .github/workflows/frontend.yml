name: Frontend CI/CD ⚙️

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build, Push & Deploy Angular Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: "aniuser"
          password: "dckr_pat_-ktgFv9zbZemgourVtBJzSlPtoI"

      - name: Get latest tag and increment 🔢
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/angular-frontend"
          latest_tag=$(curl -s https://hub.docker.com/v2/repositories/${IMAGE}/tags/?page_size=100 | jq -r '.results[].name' | grep '^v[0-9]*$' | sed 's/v//' | sort -n | tail -1)
          
          if [[ -z "$latest_tag" ]]; then
            new_tag=v1
          else
            new_tag=v$((latest_tag + 1))
          fi
          
          echo "NEW_TAG=$new_tag" >> $GITHUB_ENV
          echo "🔥 Using tag: $new_tag"

      - name: Build Docker Image 🏗️
        run: |
          cd angular-docker-example
          docker build -t aniuser/angular-frontend:${{ env.NEW_TAG }} .

      - name: Push Docker Image 🚀
        run: docker push aniuser/angular-frontend:${{ env.NEW_TAG }}

      - name: Show pushed image tag
        run: echo "✅ Successfully pushed ${{ secrets.DOCKER_USERNAME }}/angular-frontend:${{ env.NEW_TAG }}"

      # 🧠 EC2 DEPLOYMENT SECTION
      - name: Setup SSH key
        run: |
          echo "-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAoINjDQPTWao7I4WMUphWzc0y6CApr2UktK00OO/rnPZZcvrE
u8jDMlZob0fr34S2niL+OgM+i+8lj4q9QxRN/HmafRK78sNyDxHYypRs8utkccQZ
QB4zkDXLIzTCGyWuPP7vGNsW1neoEkIpIWy9xTJInX2RcM44UcJG60aeViOO3gup
r7sqEQrcocl8oM86DcsSY6ztsnvG0TLeYG4j5WKHJteTIgP34xApaaDYaFmukAph
fukR/cgGGTWPmEQHmh9A63/QYjnsAJz8/TTTf4fCKz+cQ8vwuZCO001L/wLm3/3D
eSXW3QdvGfu+fsVcGs/5QLEJaKCFvVu1MhJ4+QIDAQABAoIBACyT8LlXm6XmUiBO
Yac6qbjkSUQQUqNkiqonBD7f2uavwC3fmS2x1wwu1Tg6mDZubC1E+Kfx6LgCRcM0
u9VaWUJKH26m+k20nAO1aCjyycM5Pp8d4AlfmeBuICl56IKTl21XO94CUrhjaOkR
OM0Qny+aBHLAwdi7XQbP1tRWu3ieXM5VWPsq9+wPOhnkQzEgNg6sb2s5B320EVFR
RDSmOX00KYorufHSHCgT6FQiqE01FsL3+krl0VLSjXizbHhDJ1qVnQMLBfSiiH8r
2qQvdjZWW5tipqE/GjgcRqNH22RExtj+vfUdGs7lMc00t4sG9L9qMFC3zDsTW1Vv
9C1u39UCgYEA0kmUdtaHiIz5iI6uHj829pzEMf8i4Fa7pUiC3bR6XzWoMaVWpKEt
rceSrzAVPknKCuOtlV6fBau4FcnxQQlhMGhVLD/6aC9mKX4MKNmjlwHKoGst/Gcw
mdkAGmjFQ4nV6E3omPbhCqfp2GUKA8S7ZxXNE4w3xWFV9x2Gkq1iBOcCgYEAw2fk
FjDCDbDOjw/v5/mpYM+qFl2Vs8DF0CIoiKBw3KW/Gw95QB2e4xsGbJhUpK8o1mfQ
A/dxRdLxbV+crQYxLMVG8V8MYFdG9zdh7IqbdMEv8k/lQ0IXOABNaN/38Khe3irv
Pz4xRr5AOKzyrOBKA1UraKONPS43IJwLhCOf9x8CgYEAgJxD0tKuHdOqodwxnYoo
AXgrfjB+kho5tYK9lv7UgPp+Ha7zaMiy+T+/9KlBtNDIYxSQi3RNadh2Q804YgBs
koCc5u1SJvomT2Yp5aoGJUsRND+Y5m/uB4nySDSfwQjB7MwJX9ROGohLuu9AysE9
pHRu8m+lhHBddT93mKm18y0CgYBlTyXIA3t4kaRmM8MUKDKSyNfMRLTqvxVP9YXC
YDxjiWNtajZY8YKBCG/qOYgY4d9wWd5VUCLgKp+VLy8R3dX8+kLvvXGzOUzHu2T/
uFUk0UxEevvIRSm4lR+NMiFgGkslMGleBqaRoO229KPU0WxOEggxdioyABYAyCaI
WdgDzQKBgAhRblv52sEO/nIEVj07CJq7yUkIqK72F0xHHi/nhh0By4Iw8BmCl/G9
ggDSgnoJpHOmFxCJ4DA9q+GbUuwEBvMivh4x8dI/gUfe1PyCcJ5nctcDCYJqLmE8
HJz+gqSyEQc1e4CaQYVZI+uB5t0pJ6MNvRJyMA78uJxHpkiDH3t1
-----END RSA PRIVATE KEY-----" > asmadiya1.pem
          chmod 600 private_key.pem
      - name: Deploy to EC2 Instance 💻
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: "51.20.60.170"
          username: ubuntu
          key: "asmadiya1.pem"
          script: |
            sudo apt update -y
            sudo apt install docker.io -y

            echo "🔑 Logging into DockerHub..."
            echo "dckr_pat_-ktgFv9zbZemgourVtBJzSlPtoI" | sudo docker login -u "aniuser" --password-stdin

            echo "🛑 Stopping old container..."
            sudo docker stop angular-frontend || true
            sudo docker rm angular-frontend || true

            echo "📦 Pulling new image..."
            sudo docker pull aniuser/angular-frontend:${{ env.NEW_TAG }}

            echo "🚀 Running new container..."
            sudo docker run -d --name angular-frontend -p 80:80 aniuser/angular-frontend:${{ env.NEW_TAG }}

            echo "✅ Deployment complete! Running version: ${{ env.NEW_TAG }}"
