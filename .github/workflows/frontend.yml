name: Frontend CI/CD ⚙️

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and Push Angular Frontend Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: "aniuser"
          password: "dckr_pat_-ktgFv9zbZemgourVtBJzSlPtoI"

      # Step 1: Read or initialize version
      - name: Set Dynamic Tag 🔢
        id: version
        run: |
          # If .version file doesn't exist, start from 1
          if [ ! -f .version ]; then
            echo "1" > .version
          fi

          VERSION=$(cat .version)
          TAG="v${VERSION}"

          echo "🔥 Current version: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

          # Increment version
          NEXT_VERSION=$((VERSION + 1))
          echo $NEXT_VERSION > .version

      # Step 2: Commit updated version number
      - name: Commit Version Update 📝
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .version
          git commit -m "Bump version to v${{ env.TAG }}" || echo "No changes to commit"
          git push origin main || echo "No push access - skipping"

      # Step 3: Build Docker Image
      - name: Build Docker Image 🏗️
        run: |
          cd angular-docker-example
          docker build -t aniuser/angular-frontend:${{ env.TAG }} .

      # Step 4: Push Docker Image
      - name: Push Docker Image 🚀
        run: docker push aniuser/angular-frontend:${{ env.TAG }}
